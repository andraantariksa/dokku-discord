#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x
source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"

discord_set_cmd() {
  declare desc="Set Discord webhook URL"
  declare cmd="discord:set"
  [[ "$1" == "$cmd" ]] && shift 1

  local WEBHOOK_URL="$1"
  local APP="$2"
  local DOKKU_ROOT="${DOKKU_ROOT:-/home/dokku}"

  if [[ -z "$WEBHOOK_URL" ]]; then
    dokku_log_fail "Webhook URL required"
  fi

  # Validate webhook URL
  if [[ ! "$WEBHOOK_URL" =~ ^https?:// ]]; then
    dokku_log_fail "Invalid webhook URL. Must start with http:// or https://"
  fi

  if [[ -n "$APP" ]]; then
    # Set app-specific webhook
    verify_app_name "$APP"
    local CONFIG_PATH="$DOKKU_ROOT/$APP/DISCORD_URL"
    echo "$WEBHOOK_URL" > "$CONFIG_PATH"
    dokku_log_info1 "Discord webhook URL set for app $APP"
  else
    # Set global webhook
    local CONFIG_PATH="$DOKKU_ROOT/.discord/DISCORD_URL"
    mkdir -p "$DOKKU_ROOT/.discord"
    echo "$WEBHOOK_URL" > "$CONFIG_PATH"
    dokku_log_info1 "Discord webhook URL set globally"
  fi
}

discord_set_cmd "$@"
